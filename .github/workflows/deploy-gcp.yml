name: Deploy to Google Cloud Run

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç’°å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.github/**'
      - '!.github/workflows/**'

env:
  PROJECT_ID: gcp1-462701
  SERVICE_NAME: linebot0713
  REPOSITORY_NAME: pill-test
  IMAGE_NAME: "0713"
  REGION: us-central1

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    permissions:
      contents: read
      id-token: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        # ä½¿ç”¨æœå‹™å¸³æˆ¶é‡‘é‘° JSON æ–¹å¼
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      
    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker $REGION-docker.pkg.dev
      
    - name: Setup Artifact Registry repository
      run: |
        echo "Checking if repository $REPOSITORY_NAME exists..."
        
        # å˜—è©¦æè¿°å€‰åº«
        if gcloud artifacts repositories describe $REPOSITORY_NAME --location=$REGION >/dev/null 2>&1; then
          echo "âœ… Repository $REPOSITORY_NAME exists and is accessible"
        else
          echo "Repository $REPOSITORY_NAME does not exist. Attempting to create..."
          
          # å˜—è©¦å‰µå»ºå€‰åº«
          if gcloud artifacts repositories create $REPOSITORY_NAME \
            --repository-format=docker \
            --location=$REGION \
            --description="Docker repository for $REPOSITORY_NAME" 2>/dev/null; then
            echo "âœ… Repository $REPOSITORY_NAME created successfully"
          else
            echo "âŒ Failed to create repository. This might be due to:"
            echo "1. Repository already exists but service account lacks 'artifactregistry.repositories.get' permission"
            echo "2. Service account lacks 'artifactregistry.repositories.create' permission"
            echo ""
            echo "ğŸ”§ Quick fix - Run this command in Cloud Shell:"
            echo "gcloud artifacts repositories create $REPOSITORY_NAME --repository-format=docker --location=$REGION"
            echo ""
            echo "ğŸ“‹ Or add these permissions to service account:"
            echo "- roles/artifactregistry.admin"
            echo "- roles/artifactregistry.reader (minimum)"
            
            # ç¹¼çºŒå˜—è©¦ï¼Œä¹Ÿè¨±å€‰åº«å­˜åœ¨ä½†æ¬Šé™ä¸è¶³ä»¥æè¿°
            echo ""
            echo "âš ï¸  Continuing deployment assuming repository exists..."
          fi
        fi
        
        echo "Repository setup completed."
      
    - name: Build Docker image
      run: |
        echo "Building Docker image..."
        echo "Image name: $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY_NAME/$IMAGE_NAME:$GITHUB_SHA"
        docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY_NAME/$IMAGE_NAME:$GITHUB_SHA .
        docker tag $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY_NAME/$IMAGE_NAME:$GITHUB_SHA $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY_NAME/$IMAGE_NAME:latest
        echo "Docker images built successfully"
        docker images | grep $IMAGE_NAME
        
    - name: Push to Artifact Registry
      run: |
        echo "Pushing images to Artifact Registry..."
        echo "Repository: $REPOSITORY_NAME"
        echo "Full image path: $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY_NAME/$IMAGE_NAME"
        
        # é©—è­‰å€‰åº«å­˜åœ¨ä¸¦å¯è¨ªå•
        echo "Verifying repository access..."
        echo "Available repositories in $REGION:"
        gcloud artifacts repositories list --location=$REGION --format="table(name,format,createTime)"
        
        echo "Describing target repository $REPOSITORY_NAME:"
        gcloud artifacts repositories describe $REPOSITORY_NAME --location=$REGION
        
        echo "Pushing SHA tagged image..."
        docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY_NAME/$IMAGE_NAME:$GITHUB_SHA
        
        echo "Pushing latest tagged image..."
        docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY_NAME/$IMAGE_NAME:latest
        
        echo "âœ… Images pushed successfully"
        
    - name: Deploy to Cloud Run
      run: |
        echo "Deploying to Cloud Run..."
        echo "Service name: $SERVICE_NAME"
        echo "Image: $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY_NAME/$IMAGE_NAME:$GITHUB_SHA"
        
        # æª¢æŸ¥æœå‹™æ˜¯å¦å·²å­˜åœ¨
        if gcloud run services describe $SERVICE_NAME --region=$REGION >/dev/null 2>&1; then
          echo "âœ… Service $SERVICE_NAME exists, updating..."
        else
          echo "ğŸ†• Service $SERVICE_NAME does not exist, creating new service..."
        fi
        
        # ä½¿ç”¨é€è¡Œå¯«å…¥æ–¹å¼å‰µå»ºç’°å¢ƒè®Šæ•¸æ–‡ä»¶
        echo "LINE_CHANNEL_ACCESS_TOKEN: \"${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}\"" > env_vars.yaml
        echo "LINE_CHANNEL_SECRET: \"${{ secrets.LINE_CHANNEL_SECRET }}\"" >> env_vars.yaml
        echo "YOUR_BOT_ID: \"${{ secrets.YOUR_BOT_ID }}\"" >> env_vars.yaml
        echo "LIFF_CHANNEL_ID: \"${{ secrets.LIFF_CHANNEL_ID }}\"" >> env_vars.yaml
        echo "LIFF_ID_CAMERA: \"${{ secrets.LIFF_ID_CAMERA }}\"" >> env_vars.yaml
        echo "LIFF_ID_EDIT: \"${{ secrets.LIFF_ID_EDIT }}\"" >> env_vars.yaml
        echo "LIFF_ID_PRESCRIPTION_REMINDER: \"${{ secrets.LIFF_ID_PRESCRIPTION_REMINDER }}\"" >> env_vars.yaml
        echo "LIFF_ID_MANUAL_REMINDER: \"${{ secrets.LIFF_ID_MANUAL_REMINDER }}\"" >> env_vars.yaml
        echo "LIFF_ID_HEALTH_FORM: \"${{ secrets.LIFF_ID_HEALTH_FORM }}\"" >> env_vars.yaml
        echo "LINE_LOGIN_CHANNEL_ID: \"${{ secrets.LINE_LOGIN_CHANNEL_ID }}\"" >> env_vars.yaml
        echo "LINE_LOGIN_CHANNEL_SECRET: \"${{ secrets.LINE_LOGIN_CHANNEL_SECRET }}\"" >> env_vars.yaml
        echo "GEMINI_API_KEY: \"${{ secrets.GEMINI_API_KEY }}\"" >> env_vars.yaml
        echo "GCS_BUCKET_NAME: \"${{ secrets.GCS_BUCKET_NAME }}\"" >> env_vars.yaml
        # ä½¿ç”¨ base64 ç·¨ç¢¼ä¾†å®‰å…¨å‚³é GCP æ†‘è­‰
        echo "GCP_CREDENTIALS_BASE64: \"$(echo '${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}' | base64 -w 0)\"" >> env_vars.yaml
        echo "GOOGLE_APPLICATION_CREDENTIALS: \"/app/gcp-credentials.json\"" >> env_vars.yaml
        echo "DB_HOST: \"${{ secrets.DB_HOST }}\"" >> env_vars.yaml
        echo "DB_USER: \"${{ secrets.DB_USER }}\"" >> env_vars.yaml
        echo "DB_PASS: \"${{ secrets.DB_PASS }}\"" >> env_vars.yaml
        echo "DB_NAME: \"${{ secrets.DB_NAME }}\"" >> env_vars.yaml
        echo "DB_PORT: \"${{ secrets.DB_PORT }}\"" >> env_vars.yaml
        echo "SECRET_KEY: \"${{ secrets.SECRET_KEY }}\"" >> env_vars.yaml
        echo "REMINDER_SECRET_TOKEN: \"${{ secrets.REMINDER_SECRET_TOKEN }}\"" >> env_vars.yaml
        echo "ENABLE_PUSH_MESSAGES: \"false\"" >> env_vars.yaml
        
        echo "Generated env_vars.yaml content:"
        cat env_vars.yaml
        
        gcloud run deploy $SERVICE_NAME \
          --image $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY_NAME/$IMAGE_NAME:$GITHUB_SHA \
          --platform managed \
          --region $REGION \
          --allow-unauthenticated \
          --memory 2Gi \
          --cpu 1 \
          --timeout 900 \
          --concurrency 10 \
          --max-instances 5 \
          --min-instances 1 \
          --env-vars-file env_vars.yaml
        
    - name: Get service URL
      id: url
      run: |
        URL=$(gcloud run services describe $SERVICE_NAME --region=$REGION --format='value(status.url)')
        echo "service_url=$URL" >> $GITHUB_OUTPUT
        echo "ğŸš€ éƒ¨ç½²å®Œæˆï¼æœå‹™ URL: $URL"
        
    - name: Run health check
      run: |
        sleep 30
        curl -f ${{ steps.url.outputs.service_url }}/health || exit 1
        echo "âœ… å¥åº·æª¢æŸ¥é€šé"